<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="view_consignment_product_simple_form" model="ir.ui.view">
        <field name="name">consignment.product.simple.form</field>
        <field name="model">product.template</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <group>
                        <field name="image_1920" widget="image" class="oe_avatar"/>
                        <group>
                            <field name="name" required="1"/>
                            <field name="default_code" placeholder="Laat leeg voor auto-generatie"/>
                            <field name="brand_id" placeholder="Kies een merk..."/>
                            <field name="is_storable" string="Voorraad bijhouden"/>
                            <field name="qty_available" string="Aanwezige Voorraad" invisible="not is_storable"/>
                            <field name="public_categ_ids" widget="many2many_tags"/>
                            <field name="list_price"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Kenmerken">
                            <field name="attribute_line_ids">
                                <list editable="bottom">
                                    <field name="attribute_id" required="1"/>
                                    <field name="value_ids" widget="many2many_tags" options="{'no_create_edit': True}" domain="[('attribute_id', '=', attribute_id)]"/>
                                </list>
                            </field>
                        </page>
                        <page string="Extra Afbeeldingen">
                            <field name="product_template_image_ids">
                                <list editable="bottom">
                                    <field name="name"/>
                                    <field name="image_1920" widget="image" options="{'size': [50, 50]}"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_consignment_submission_search" model="ir.ui.view">
        <field name="name">consignment.submission.search</field>
        <field name="model">otters.consignment.submission</field>
        <field name="arch" type="xml">
            <search string="Zoek Inzendingen">
                <field name="name"/>
                <field name="supplier_id"/>
                <field name="x_submission_year"/>
                <field name="x_legacy_code"/>

                <separator/>
                <filter string="Nieuw" name="status_draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Online" name="status_online" domain="[('state', '=', 'online')]"/>
                <separator/>

                <filter string="Leverancier" name="group_supplier" context="{'group_by': 'supplier_id'}"/>
                <filter string="Jaar" name="group_year" context="{'group_by': 'submission_date:year'}"/>
                <filter string="Status" name="group_state" context="{'group_by': 'state'}"/>
            </search>
        </field>
    </record>

    <record id="view_consignment_submission_list" model="ir.ui.view">
        <field name="name">consignment.submission.list</field>
        <field name="model">otters.consignment.submission</field>
        <field name="arch" type="xml">
            <list>
                <field name="name"/>
                <field name="supplier_id"/>
                <field name="x_submission_year" optional="show" widget="char"/>
                <field name="submission_date"/>
                <field name="date_published"/>
                <field name="x_legacy_code" optional="show"/>


                <field name="product_count" sum="Totaal Stuks" string="Aantal OK"/>
                <field name="rejected_count" sum="Totaal Geweigerd" string="Geweigerd" optional="show" decoration-danger="rejected_count > 0"/>

                <field name="payout_method"/>
                <field name="payout_percentage" widget="percentage" options="{'digits': [1, 0]}"/>
                <field name="state" widget="badge"/>
            </list>
        </field>
    </record>

    <record id="view_consignment_submission_form" model="ir.ui.view">
        <field name="name">consignment.submission.form</field>
        <field name="model">otters.consignment.submission</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="%(action_import_products_wizard)d" string="Importeer Producten (CSV)" type="action" class="oe_highlight"/>

                    <button name="action_generate_sendcloud_label"
                            string="Maak Verzendlabel (Sendcloud)"
                            type="object"
                            class="btn-primary"
                            confirm="Ben je zeker? Dit maakt een label aan bij Sendcloud en brengt kosten in rekening."/>

                    <button name="%(action_bulk_remove_wizard)d"
                            string="Alles uit collectie halen"
                            type="action"
                            class="btn-secondary"
                            invisible="state == 'cancel'"/>

                    <button name="action_set_online_and_notify"
                            string="üöÄ Zet Online &amp; Mail Klant"
                            type="object"
                            class="btn-primary"
                            confirm="Dit zet de status op 'Online' en stuurt een mail naar de klant. Doorgaan?"/>

                    <field name="state" widget="statusbar"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_products"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-shirtsinbulk">
                            <field name="product_count" widget="statinfo" string="Producten"/>
                        </button>
                        <button class="oe_stat_button" icon="fa-ban" disabled="1">
                            <field name="rejected_count" widget="statinfo" string="Geweigerd"/>
                        </button>
                    </div>

                    <div class="oe_title">
                        <h1><field name="name" readonly="1"/></h1>
                    </div>

                    <group>
                        <group string="Inzending Details">
                            <field name="supplier_id"/>
                            <field name="submission_date"/>
                            <field name="date_published"/>
                            <field name="x_submission_year" readonly="1" options="{'format': false}" widget="char"/>
                            <field name="state"/>
                            <field name="label_count" string="Aantal Zakken" readonly="1"/>
                        </group>

                        <group string="Uitbetaling">
                            <field name="payout_method"/>
                            <field name="payout_percentage" widget="percentage" options="{'digits': [1, 0]}"/>

                            <field name="x_iban" invisible="payout_method != 'cash'"/>
                        </group>

                        <group string="Promoties &amp; Korting">
                            <label for="discount_percentage"/>
                            <div class="o_row">
                                <field name="discount_percentage" class="oe_inline"/>
                                <span class="oe_inline">%</span>
                                <button name="action_apply_discount" string="Toepassen/Herrekenen" type="object" class="btn-sm btn-link"/>
                            </div>
                            <field name="discount_reason" placeholder="Bv. Einde seizoen opruiming" invisible="discount_percentage == 0"/>
                        </group>

                        <group string="Geaccepteerde Voorwaarden">
                            <field name="agreed_to_terms" readonly="1"/>
                            <field name="agreed_to_clothing_terms" readonly="1"/>
                            <field name="agreed_to_shipping_fee" readonly="1"/>
                        </group>
                        <group string="Keuzes bij niet geaccepteerd/verkocht">
                            <field name="action_unaccepted"/>
                            <field name="action_unsold"/>
                        </group>
                        <group string="Gegenereerde Labels" invisible="not label_ids">
                            <field name="label_ids" nolabel="1">
                                <list editable="bottom" create="0" delete="0">
                                    <field name="tracking_number"/>
                                    <field name="label_url" widget="url" text="Download PDF"/>
                                    <button name="action_open_url" type="object" icon="fa-external-link" title="Open Label"/>
                                </list>
                            </field>
                        </group>
                        <group string="Historie">
                            <field name="x_old_id"/>
                            <field name="x_legacy_code"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Producten">
                            <field name="product_ids"
                                   context="{
                                       'default_is_published': True,
                                       'form_view_ref': 'otters_consignment.view_consignment_product_simple_form'
                                   }">

                                <list>
                                    <field name="name"/>
                                    <field name="brand_id" optional="show"/>
                                    <field name="default_code" optional="show"/>
                                    <field name="public_categ_ids" widget="many2many_tags" optional="hide"/>
                                    <field name="list_price"/>
                                    <field name="qty_available" string="Voorraad"/>
                                    <field name="is_published" string="Online"/>
                                    <field name="x_payout_date" string="Uitbetaald op" optional="show"/>
                                    <field name="x_unsold_reason" optional="hide" widget="badge" decoration-warning="x_unsold_reason != False"/>
                                </list>
                            </field>
                        </page>

                        <page string="Niet Weerhouden producten">
                            <field name="rejected_line_ids">
                                <list editable="bottom">
                                    <field name="product_name"/>
                                    <field name="reason"/>
                                    <field name="note" optional="show"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_consignment_submission" model="ir.actions.act_window">
        <field name="name">Inzendingen</field>
        <field name="res_model">otters.consignment.submission</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="view_consignment_submission_search"/>
    </record>

    <record id="action_fix_split_sizes" model="ir.actions.server">
        <field name="name">‚úÇÔ∏è Splits Gecombineerde Maten (Naar Aparte Regels)</field>
        <field name="model_id" ref="product.model_product_template"/>
        <field name="binding_model_id" ref="product.model_product_template"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
ATTR_NAME = "Maat"

# 1. Attribuut zoeken
attribute = env['product.attribute'].search([('name', '=ilike', ATTR_NAME)], limit=1)
if not attribute:
    raise UserError(f"Attribuut '{ATTR_NAME}' niet gevonden!")

# 2. Zoek waarden met een slash
bad_values = env['product.attribute.value'].search([
    ('attribute_id', '=', attribute.id),
    ('name', 'like', '/')
])

products_fixed_count = 0

for bad_val in bad_values:
    # "122/128" -> ["122", "128"]
    new_size_names = [x.strip() for x in bad_val.name.split('/') if x.strip()]
    if not new_size_names: continue

    # Zoek alle producten die deze foute waarde hebben
    lines_to_fix = env['product.template.attribute.line'].search([
        ('attribute_id', '=', attribute.id),
        ('value_ids', 'in', bad_val.id)
    ])

    for line in lines_to_fix:
        product = line.product_tmpl_id

        # STAP A: Verwijder de oude lijn met "122/128"
        line.unlink()

        # STAP B: Maak voor elk nieuw deel een NIEUWE lijn
        for size_name in new_size_names:
            # Zoek/Maak de waarde (122 of 128)
            val_obj = env['product.attribute.value'].search([
                ('attribute_id', '=', attribute.id),
                ('name', '=', size_name)
            ], limit=1)

            if not val_obj:
                val_obj = env['product.attribute.value'].create({
                    'name': size_name,
                    'attribute_id': attribute.id,
                    'sequence': 10
                })

            # Maak de nieuwe lijn aan op het product
            env['product.template.attribute.line'].create({
                'product_tmpl_id': product.id,
                'attribute_id': attribute.id,
                'value_ids': [(6, 0, [val_obj.id])]
            })

        products_fixed_count += 1

action = {
    'type': 'ir.actions.client',
    'tag': 'display_notification',
    'params': {
        'title': 'Splitsing Voltooid',
        'message': f'{products_fixed_count} producten hebben nu aparte regels voor dubbele maten.',
        'type': 'success',
        'sticky': False,
    }
}
        </field>
    </record>
    <record id="product_template_search_view_inherit_otters" model="ir.ui.view">
        <field name="name">product.template.search.otters</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_search_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='name']" position="attributes">
                <attribute name="filter_domain">['|', '|', ('default_code', 'ilike', self), ('name', 'ilike', self), ('barcode', 'ilike', self)]</attribute>
            </xpath>

            <xpath expr="//field[@name='name']" position="after">
                <field name="default_code" string="Code (Exact)"/>
            </xpath>
        </field>
    </record>

    <menuitem id="menu_consignment_root" name="Verzendlabels" sequence="10"/>
    <menuitem id="menu_consignment_submission" name="Inzendingen" parent="otters_consignment.menu_consignment_root" action="action_consignment_submission" sequence="10"/>
</odoo>