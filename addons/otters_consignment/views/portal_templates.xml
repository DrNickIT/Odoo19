<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="portal_my_home_menu_consignment" name="Portal My Home: Consignment Menu"
              inherit_id="portal.portal_my_home" priority="99">
        <xpath expr="//div[hasclass('o_portal_my_home')]" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="icon" t-value="'/otters_consignment/static/src/img/consignment_icon.png'"/>
                <t t-set="title">Mijn Inzendingen</t>
                <t t-set="text">Bekijk de status van je opgestuurde kleren</t>
                <t t-set="url" t-value="'/my/consignments'"/>
                <t t-set="config_card" t-value="True"/>
            </t>
        </xpath>
    </template>

    <template id="portal_my_consignments" name="Mijn Consignaties">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs" t-value="[
                ('my_home', {'title': 'Mijn Portaal'}),
                ('my_consignments', {'title': 'Mijn Inzendingen'})
            ]"/>

            <div class="container">
                <h3>Mijn Inzendingen</h3>
                <t t-if="not submissions">
                    <div class="alert alert-info" role="alert">
                        Je hebt nog geen inzendingen.
                    </div>
                </t>
                <t t-if="submissions">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Datum</th>
                                <th>Status</th>
                                <th>Uitbetaalmethode</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr t-foreach="submissions" t-as="submission">
                                <td>
                                    <a t-att-href="'/my/consignments/%s' % submission.id">
                                        <span t-field="submission.name"/>
                                    </a>
                                </td>
                                <td><span t-field="submission.submission_date" t-options="{'widget': 'date'}"/></td>
                                <td><span t-field="submission.state"/></td>
                                <td><span t-field="submission.payout_method"/></td>
                            </tr>
                        </tbody>
                    </table>
                </t>
                <div t-if="pager" class="o_portal_pager">
                    <t t-call="portal.pager"/>
                </div>
            </div>
        </t>
    </template>

    <template id="portal_consignment_submission" name="Consignatie Details">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs" t-value="[
            ('my_home', {'title': 'Mijn Portaal'}),
            ('my_consignments', {'title': 'Mijn Inzendingen', 'url': '/my/consignments'}),
            ('submission', {'title': submission.name})
        ]"/>

            <div class="card o_portal_details">
                <div class="card-header">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="mb-0">
                                Inzending: <b t-field="submission.name"/>
                            </h5>
                            <div class="text-muted">
                                Status: <span t-field="submission.state"/>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <small class="text-muted">Uitbetaal-afspraak:</small><br/>
                            <strong t-if="submission.payout_method == 'cash'">
                                <span t-out="'{:.0f}'.format(submission.payout_percentage * 100)"/>% in Cash
                            </strong>
                            <strong t-if="submission.payout_method == 'coupon'">
                                <span t-out="'{:.0f}'.format(submission.payout_percentage * 100)"/>% in Tegoedbon
                            </strong>
                        </div>
                    </div>

                    <div class="row mt-3 pt-2 border-top">
                        <div class="col-md-6">
                            <small class="text-muted">Actie bij niet-weerhouden items:</small><br/>
                            <i class="fa fa-hand-holding-heart text-info" t-if="submission.action_unaccepted == 'donate'"/>
                            <i class="fa fa-truck text-warning" t-if="submission.action_unaccepted == 'return'"/>
                            <span t-field="submission.action_unaccepted"/>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <small class="text-muted">Actie bij niet-verkocht (na 1 jaar):</small><br/>
                            <span t-field="submission.action_unsold"/>
                            <i class="fa fa-hand-holding-heart text-info" t-if="submission.action_unsold == 'donate'"/>
                            <i class="fa fa-truck text-warning" t-if="submission.action_unsold == 'return'"/>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <t t-if="submission.discount_percentage > 0">
                        <div class="alert alert-warning d-flex align-items-center" role="alert">
                            <i class="fa fa-percent fa-2x me-3"/>
                            <div>
                                <h5 class="alert-heading mb-1">
                                    Promotie Actief: <t t-out="submission.discount_percentage"/>% Korting
                                </h5>
                                <p class="mb-0">
                                    De prijzen van je items zijn tijdelijk verlaagd om de verkoop te stimuleren.
                                    <br/>
                                    <strong>Reden:</strong> <span t-field="submission.discount_reason"/>
                                </p>
                            </div>
                        </div>
                    </t>
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="stock-tab" data-bs-toggle="tab" href="#stock" role="tab">
                                In Voorraad (<t t-out="len(stock_products)"/>)
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="unpaid-tab" data-bs-toggle="tab" href="#unpaid" role="tab">
                                Verkocht: Nog te Betalen (<t t-out="len(aggregated_unpaid)"/>)
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="paid-tab" data-bs-toggle="tab" href="#paid" role="tab">
                                Verkocht: Reeds Uitbetaald (<t t-out="len(aggregated_paid)"/>)
                            </a>
                        </li>

                        <li class="nav-item" t-if="removed_products">
                            <a class="nav-link text-warning" id="removed-tab" data-bs-toggle="tab" href="#removed" role="tab">
                                Uit Collectie (<t t-out="len(removed_products)"/>)
                            </a>
                        </li>

                        <li class="nav-item" t-if="submission.rejected_line_ids">
                            <a class="nav-link text-danger" id="rejected-tab" data-bs-toggle="tab" href="#rejected" role="tab">
                                Niet Weerhouden (<t t-out="len(submission.rejected_line_ids)"/>)
                            </a>
                        </li>
                    </ul>

                    <div class="tab-content pt-3" id="myTabContent">

                        <div class="tab-pane fade show active" id="stock" role="tabpanel" aria-labelledby="stock-tab">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th class="text-end">Jouw Prijs</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="stock_products" t-as="product">
                                        <td><span t-field="product.name"/></td>
                                        <td class="text-end">
                                            <t t-if="product.compare_list_price and product.compare_list_price > product.list_price">
                                                <span class="text-muted text-decoration-line-through me-1"
                                                      t-field="product.compare_list_price"
                                                      t-options="{'widget': 'monetary', 'display_currency': submission.supplier_id.currency_id}"/>
                                                <br/>
                                            </t>

                                            <span t-field="product.list_price"
                                                  t-options="{'widget': 'monetary', 'display_currency': submission.supplier_id.currency_id}"
                                                  t-att-class="'fw-bold text-danger' if product.compare_list_price else ''"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tab-pane fade" id="unpaid" role="tabpanel" aria-labelledby="unpaid-tab">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th class="text-end">Aantal</th>
                                        <th class="text-end">Verkoopprijs</th>
                                        <th class="text-end">Jouw Uitbetaling</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="aggregated_unpaid" t-as="line"> <td><span t-out="line['name']"/></td>
                                        <td class="text-end"><span t-out="line['qty']"/> st</td>
                                        <td class="text-end">
                                            <t t-set="prod" t-value="line['product']"/>
                                            <t t-set="unit_price" t-value="line['price_sold'] / line['qty']"/>

                                            <t t-if="prod.compare_list_price and prod.compare_list_price > unit_price">
                                                <span class="text-muted text-decoration-line-through me-1"
                                                      t-out="prod.compare_list_price * line['qty']"
                                                      t-options="{'widget': 'monetary', 'display_currency': submission.supplier_id.currency_id}"/>
                                                <br/>
                                            </t>

                                            <span t-out="line['price_sold']"
                                                  t-options="{'widget': 'monetary', 'display_currency': submission.supplier_id.currency_id}"
                                                  class="fw-bold"/>
                                        </td>
                                        <td class="text-end">
                                            <span t-out="line['payout']" t-options="{'widget': 'monetary', 'display_currency': submission.supplier_id.currency_id}"/>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="bg-light">
                                        <td colspan="3" class="text-end">
                                            <strong>Totaal nog uit te betalen:</strong>
                                        </td>
                                        <td class="text-end">
                                            <strong t-out="total_payout_unpaid" t-options="{'widget': 'monetary', 'display_currency': submission.supplier_id.currency_id}"/>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="tab-pane fade" id="paid" role="tabpanel" aria-labelledby="paid-tab">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th class="text-end">Datum</th>
                                        <th class="text-end">Aantal</th>
                                        <th class="text-end">Verkoopprijs</th>
                                        <th class="text-end">Uitbetaald Bedrag</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="aggregated_paid" t-as="line">
                                        <td><span t-out="line['name']"/></td>
                                        <td class="text-end">
                                            <span t-out="line['date']" t-options='{"widget": "date"}'/>
                                        </td>
                                        <td class="text-end"><span t-out="line['qty']"/> st</td>
                                        <td class="text-end">
                                            <t t-set="prod" t-value="line['product']"/>
                                            <t t-set="unit_price" t-value="line['price_sold'] / (line['qty'] or 1)"/>
                                            <t t-if="prod.compare_list_price and prod.compare_list_price > unit_price">
                                                <span class="text-muted text-decoration-line-through me-1"
                                                      t-out="prod.compare_list_price * line['qty']"
                                                      t-options="{'widget': 'monetary', 'display_currency': submission.supplier_id.currency_id}"/>
                                                <br/>
                                            </t>

                                            <span t-out="line['price_sold']"
                                                  t-options="{'widget': 'monetary', 'display_currency': submission.supplier_id.currency_id}"
                                                  class="fw-bold"/>
                                        </td>
                                        <td class="text-end">
                                            <span t-out="line['payout']" t-options="{'widget': 'monetary', 'display_currency': submission.supplier_id.currency_id}"/>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="fw-bold bg-light border-top">
                                        <td colspan="4" class="text-end">Totaal Reeds Uitbetaald:</td>

                                        <td class="text-end text-success">
                                            <span t-out="total_payout_paid"
                                                  t-options="{'widget': 'monetary', 'display_currency': submission.supplier_id.currency_id}"/>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="tab-pane fade" id="removed" role="tabpanel">
                            <div class="alert alert-light border mb-3">
                                <i class="fa fa-info-circle text-warning"/> Deze items zijn uit de verkoop gehaald (niet verkocht).
                            </div>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Reden</th>
                                        <th class="text-end">Oorspr. Prijs</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="removed_products" t-as="product">
                                        <td>
                                            <span t-field="product.name"/>
                                            <br/>
                                            <small class="text-muted"><span t-field="product.default_code"/></small>
                                        </td>
                                        <td>
                                            <t t-if="product.x_unsold_reason == 'charity'">
                                                <span class="badge text-bg-success">Geschonken aan goed doel</span>
                                            </t>
                                            <t t-elif="product.x_unsold_reason == 'returned'">
                                                <span class="badge text-bg-info">Teruggestuurd naar jou</span>
                                            </t>
                                            <t t-elif="product.x_unsold_reason == 'lost'">
                                                <span class="badge text-bg-danger">Verloren / Beschadigd</span>
                                            </t>
                                            <t t-else="">
                                                <span t-field="product.x_unsold_reason"/>
                                            </t>
                                        </td>
                                        <td class="text-end">
                                            <span t-field="product.list_price" t-options="{'widget': 'monetary', 'display_currency': submission.supplier_id.currency_id}"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tab-pane fade" id="rejected" role="tabpanel" aria-labelledby="rejected-tab">
                            <div class="alert alert-light border mb-3">
                                <i class="fa fa-info-circle text-info"/> Deze items zijn niet online geplaatst.
                                Zie uw keuze hierboven ("Actie bij niet-weerhouden") voor wat hiermee gebeurt.
                            </div>
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Omschrijving</th>
                                        <th>Reden</th>
                                        <th>Extra Info</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="submission.rejected_line_ids" t-as="line">
                                        <td><span t-field="line.product_name"/></td>
                                        <td><span t-field="line.reason"/></td>
                                        <td><span t-field="line.note"/></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>
